<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HMPI Map Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 90vh; width: 100%; }
    .legend { background: white; padding: 6px; border-radius: 4px; font-size: 14px; }
    .leaflet-popup-content { font-size: 14px; font-weight: 500; }
    .hover-popup { font-weight: bold; color: #111; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <script>
    const data = {"type": "FeatureCollection", "features": [
      {"type":"Feature","geometry":{"type":"Point","coordinates":[78.486,17.385]},"properties":{"site_name":"SiteA","hpi":98.27}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[77.209,28.6139]},"properties":{"site_name":"Delhi","hpi":56.67}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[72.8777,19.076]},"properties":{"site_name":"Mumbai","hpi":160.99}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[88.3639,22.5726]},"properties":{"site_name":"Kolkata","hpi":92.79}},
      {"type":"Feature","geometry":{"type":"Point","coordinates":[80.2707,13.0827]},"properties":{"site_name":"Chennai","hpi":26.13}}
    ]};

    // Center map on India
    const map = L.map('map').setView([22.3511148, 78.6677428], 5);

    // Base map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    // Color scale (same as your first version)
    function getColor(h) {
      return h > 150 ? '#800026' :
             h > 100 ? '#BD0026' :
             h > 75  ? '#E31A1C' :
             h > 50  ? '#FC4E2A' :
             h > 25  ? '#FD8D3C' :
             h > 10  ? '#FEB24C' :
                       '#FFEDA0';
    }

    // Heatmap layer
    const heatData = data.features.map(f => [f.geometry.coordinates[1], f.geometry.coordinates[0], Math.max(f.properties.hpi/200, 0.1)]);
    const heat = L.heatLayer(heatData, {radius: 40, blur: 25, maxZoom: 12}).addTo(map);

    // Marker layer
    const markers = L.layerGroup();
    data.features.forEach(f => {
      const lat = f.geometry.coordinates[1], lon = f.geometry.coordinates[0];
      const h = f.properties.hpi;
      const mk = L.circleMarker([lat,lon], {
        radius: 9,
        fillColor: getColor(h),
        color: "#000",
        weight: 1,
        fillOpacity: 0.9
      });

      // Popup + hover interactivity
      mk.bindPopup(`<div class="hover-popup"><b>${f.properties.site_name}</b><br>HPI: ${h}</div>`);
      mk.on("mouseover", function () { this.openPopup(); this.setStyle({radius: 12, weight: 2}); });
      mk.on("mouseout", function () { this.closePopup(); this.setStyle({radius: 9, weight: 1}); });

      markers.addLayer(mk);
    });
    markers.addTo(map);

    // Layer control
    L.control.layers({}, { "Heatmap": heat, "Sampling Sites": markers }).addTo(map);

    // Legend
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<b>HPI Scale</b><br>' +
                      '<i style="background:#800026;width:18px;height:12px;display:inline-block"></i> >150<br>' +
                      '<i style="background:#BD0026;width:18px;height:12px;display:inline-block"></i> 101-150<br>' +
                      '<i style="background:#E31A1C;width:18px;height:12px;display:inline-block"></i> 76-100<br>' +
                      '<i style="background:#FC4E2A;width:18px;height:12px;display:inline-block"></i> 51-75<br>' +
                      '<i style="background:#FD8D3C;width:18px;height:12px;display:inline-block"></i> 26-50<br>' +
                      '<i style="background:#FEB24C;width:18px;height:12px;display:inline-block"></i> 11-25<br>' +
                      '<i style="background:#FFEDA0;width:18px;height:12px;display:inline-block"></i> 0-10<br>';
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
